<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://java.sun.com/jsf/html"
      xmlns:f="http://java.sun.com/jsf/core"
      xmlns:p="http://primefaces.org/ui"
      xmlns:ui="http://java.sun.com/jsf/facelets"
      xmlns:pe="http://primefaces.org/ui/extensions">

    <script type="text/javascript">
        function editLastDatatableRow() {
            jQuery('.ui-datatable-data tr').last().find('span.ui-icon-pencil').each(function () {
                jQuery(this).click()
            });
        }
    </script>
    <ui:decorate template="/resources/templates/template.xhtml">	

        <!-- Center Content -->
        <ui:define name="conteudo_centro">
            <h:form id="form">
                <p:growl id="growl" autoUpdate="true" showDetail="true"
                         showSummary="true" />      

                <p:wizard widgetVar="wizard" nextLabel="Avançar" backLabel="Voltar" flowListener="#{workflowComposerBean.flowController}">
                    <p:tab id="initial" title="Início">
                        <p:panel>
                            <h:panelGrid columns="2" width="100%">
                                <p:panel header="Importar Workflow" style="width: 400px; margin: 60px">
                                    <center>
                                        <p:fileUpload id="file_upload" mode="advanced" 
                                                      dragDropSupport="false" multiple="false" 
                                                      invalidFileMessage="Formato de arquivo inválido"
                                                      fileUploadListener="#{workflowComposerBean.handleImportedWorkflow}"
                                                      cancelLabel="Cancelar" uploadLabel="Enviar"
                                                      label="Escolher Arquivo" allowTypes="/(\.|\/)(flow)$/"
                                                      update="growl" sizeLimit="268435456"/>
                                    </center>
                                </p:panel>

                                <p:panel header="Iniciar Workflow" style="width: 400px; margin: 60px">
                                    <center>
                                        <p:commandButton value="Começar Projeto" onclick="PF('wizard').next();"/>  
                                    </center>
                                </p:panel>
                            </h:panelGrid>
                        </p:panel>
                    </p:tab>

                    <p:tab id="sla_option" title="SLA">
                        <p:tabView>
                            <p:tab title="Detalhado">
                                <p:panel style="border-color: #2980b9">
                                    
                                    <h:panelGroup>
                                        <p:outputLabel value="Limitar a execução:" />
                                        <p:selectOneRadio value="#{slaComposerBean.panel1}">
                                            <f:selectItem itemLabel="Sim" itemValue="Show-Panel1" />
                                            <f:selectItem itemLabel="Não" itemValue="Hide-Panel1" />
                                            <f:ajax render="select-type-limitation-panel" />
                                        </p:selectOneRadio>
                                    </h:panelGroup>
                                    <p:panelGrid columns="2" rendered="#{slaComposerBean.panel1 == 'Show-Panel1'}">
                                        <h:panelGroup id="select-type-limitation-panel">

                                            <!--<p:outputPanel id="select_type_limitation" style="margin-bottom:10px">-->
                                            <p:selectOneRadio id="sla_type_limitation" value="#{slaComposerBean.limitationType}">
                                                <f:selectItem itemLabel="Tempo de execução" itemValue="#{slaComposerBean.limitationType}" />
                                                <f:selectItem itemLabel="Custo de execução" itemValue="#{slaComposerBean.limitationType}" />
                                            </p:selectOneRadio>

                                            <h:panelGrid columns="3" cellpadding="5" >
                                                <p:radioButton id="opt1" for="sla_type_limitation" itemIndex="0" />
                                                <p:outputLabel for="opt1" value="Tempo de execução: " />
                                                <p:inputMask id="opt1N" value="#{slaComposerBean.limitationValue}" mask="00:00:00"/>


                                                <p:radioButton id="opt2" for="sla_type_limitation" itemIndex="1" />
                                                <h:outputLabel for="opt2" value="Custo de execução" />
                                                <p:inputMask id="opt2N" value="#{slaComposerBean.limitationValue}" mask="0,00"/>  

                                            </h:panelGrid>
                                            <!--</p:outputPanel>-->

                                        </h:panelGroup>

                                    </p:panelGrid>
                                    
                                    <p:outputPanel id="instancies_types" style="margin-bottom:10px">
                                        <p:outputLabel value="Tipos de instâncias:" /> <br />
                                        <p:dataTable value="#{slaComposerBean.instancies}" var="instance" style="width: 60em"
                                                     paginator="true" rows="5" emptyMessage="Quantidade de instância "
                                                     selection="#{slaComposerBean.selectedInstancies}" rowKey="#{instance.type}" editable="true" editMode="cell">

                                            <p:column headerText="Tipo" width="25em" style="text-align: center">
                                                <p:outputLabel value="#{instance.type}"/>
                                            </p:column>

                                            <p:column headerText="Quantidade" width="25em" style="text-align: center">
                                                <p:cellEditor>
                                                    <f:facet name="output"><h:outputLabel value="#{instance.quantity}"/></f:facet>
                                                    <f:facet name="input"><pe:inputNumber value="#{instance.quantity}" style="width:100%" label="Quantidade" maxValue="100" maxlength="3"/></f:facet>   
                                                </p:cellEditor>
                                            </p:column>

                                            <p:column headerText="Escolha" style="text-align: center" selectionMode="multiple" />
                                        </p:dataTable>
                                    </p:outputPanel>
<!--                                    <p:panelGrid columns="3" id="instances">
                                        <p:column headerText="Instância" style="text-align: center">
                                            <p:selectOneMenu id="instance" value="#{slaComposerBean.chosenInstanceId}"  style="width:100%" required="true" requiredMessage="Campo instância obrigatório">
                                                <f:selectItems value="#{slaComposerBean.instancies}" var="man" itemLabel="#{man.description}" itemValue="#{man.id}" />
                                            </p:selectOneMenu>
                                        </p:column>
                                        <p:column headerText="Quantidade" style="text-align: center">
                                            <h:outputText value="#{man.quantity}" />
                                            <pe:inputNumber value="#{man.quantity}" style="width:100%" label="Quantidade"  minValue="0" maxValue="100" maxlength="3" />
                                        </p:column>    
                                        <p:column>
                                                <p:commandButton action="#{slaComposerBean.addSelectedInstance()}"
                                                                 icon="ui-icon-check" 
                                                                 update="selected_instances, :form:growl"
                                                                 iconPos="left" />
                                        </p:column>
                                    </p:panelGrid>
                                    <p:outputPanel id="selected_instances" style="margin-bottom:10px">
                                        <p:dataTable value="#{slaComposerBean.selectedInstancies}" var="instance" style="width: 60em"
                                                     paginator="true" rows="5" emptyMessage="Nenhuma instância adicionada" 
                                                     id="instancesList">
                                            <f:facet name="header"> <center>Tipos de instâncias:</center></f:facet>
                                            <p:column headerText="Tipo" width="25em" style="text-align: center">
                                                <p:outputLabel value="#{instance.description}"/>
                                            </p:column>

                                            <p:column headerText="Quantidade" width="25em" style="text-align: center">
                                                <f:facet name="output"><h:outputLabel value="#{instance.quantity}"/></f:facet>
                                            </p:column>

                                            <p:column>
                                                <p:commandButton icon="ui-icon-circle-close" action="#{slaComposerBean.removeElement(e)}" update=":form:selected_instances"/>
                                            </p:column>
                                        </p:dataTable>
                                    </p:outputPanel>-->
                                </p:panel> 

                            </p:tab>
                            <p:tab title="Padrao">
                                <h:panelGrid columns="2" cellpadding="10">
                                    <p:graphicImage name="demo/images/godfather/godfather2.jpg" />
                                    <h:outputText value="Francis Ford Coppola's legendary..." />
                                </h:panelGrid>
                            </p:tab>
                        </p:tabView>
                        <!--</p:panel>-->
                    </p:tab>



                    <!-- Element selection tab -->
                    <p:tab id="element_selection" title="Seleção de Elementos">
                        <p:panel header="Escolha os elementos deste Workflow">
                            <p:panel style="border-color: #2980b9">
                                <p:outputLabel value="De uma breve descrição deste workflow" /> <br />
                                <p:inputText value="#{workflowComposerBean.workflowDescription}" style="width: 99%"
                                             required="true" requiredMessage="Campo 'Descrição' obrigatorio" />
                            </p:panel> 
                            <br />
                            <p:fieldset legend="Elementos disponíveis" style="border-color: #2980b9">
                                <p:panel style="border-color: #2980b9">
                                    <p:outputLabel value="Escolha os elementos que irão compor este workflow." />
                                </p:panel> 
                                <br />
                                <center>
                                    <p:dataGrid var="s" value="#{workflowComposerBean.servicesList}" columns="4" layout="grid"
                                                id="elements" paginator="true" rows="4">
                                        <f:facet name="header" >
                                            Elementos
                                        </f:facet>

                                        <p:panel header="#{s.name}" style="text-align:center">
                                            <h:panelGrid columns="1" style="width:100%">
                                                <h:outputText value="#{s.info}" />
                                                <hr style="color: #2980b9"/>
                                                <f:facet name="footer">
                                                    <p:commandButton action="#{workflowComposerBean.addElement(s)}"
                                                                     value="Adicionar" icon="ui-icon-check" 
                                                                     update=":form:chosen_elements, :form:growl"
                                                                     iconPos="left" />
                                                </f:facet>
                                            </h:panelGrid>
                                        </p:panel>

                                    </p:dataGrid>
                                </center>
                            </p:fieldset>
                            <br />
                            <p:fieldset id="chosen_elements" legend="Elementos escolhidos" style="border-color: #2980b9">
                                <center>
                                    <p:dataTable value="#{workflowComposerBean.elements}" var="e" style="width: 400px"
                                                 emptyMessage="Nenhum elemento adicionado" paginator="true" rows="8">
                                        <p:column headerText="Elemento">
                                            <p:outputLabel value="#{e.name}"/>
                                        </p:column>

                                        <p:column headerText="Excluir" style="text-align: center">
                                            <p:commandButton icon="ui-icon-circle-close" action="#{workflowComposerBean.removeElement(e)}" update=":form:chosen_elements"/>
                                        </p:column>
                                    </p:dataTable>
                                </center>
                            </p:fieldset>
                        </p:panel>
                    </p:tab>

                    <p:tab id="workflow_design" title="Desenho do Workflow">
                        <p:panel id="workflow_pnl">   
                            <!-- ======== Diagram ======== -->
                            <p:panel>
                                <f:facet name="header">
                                    <center>
                                        <p:outputLabel value="Diagrama" />
                                    </center>
                                </f:facet>
                                <p:diagram id="workflow_diagram"
                                           value="#{workflowComposerBean.workflowModel}"
                                           style="height:500px" >
                                    <p:ajax event="connect" listener="#{workflowComposerBean.onConnect}" />
                                    <p:ajax event="disconnect" listener="#{workflowComposerBean.onDisconnect}" />
                                    <p:ajax event="connectionChange" listener="#{workflowComposerBean.onConnectionChange}" />
                                </p:diagram>
                            </p:panel>
                        </p:panel>
                    </p:tab>

                    <p:tab id="workflow_summary" title="Resumo deste Workflow">
                        <p:panel>
                            <p:panel>
                                Confira aqui o resumo desta execução. Ao clicar em "Confirmar Workflow" será iniciada sua execução.
                            </p:panel>
                            <br />
                            <p:panel>
                                <p:panelGrid columns="2" style="width: 100%; margin: 15px">
                                    <f:facet name="header">
                                        <p:outputLabel value="Dados deste workflow" style="font-size: 120%; margin: 10px"/>
                                    </f:facet>
                                    <p:outputLabel value="Id" style="font-weight: bold"/>
                                    <p:outputLabel value="#{workflowComposerBean.workflow.id}" style="font-weight: bold"/>
                                    <p:outputLabel value="Descrição" style="font-weight: bold"/>
                                    <p:outputLabel value="#{workflowComposerBean.workflow.description} " />
                                    <p:outputLabel value="Tamanho" style="font-weight: bold"/>
                                    <p:outputLabel value="#{workflowComposerBean.workflow.jobs.size()} Job(s)" />
                                    <p:outputLabel value="Criado em" style="font-weight: bold"/>
                                    <p:outputLabel value="#{workflowComposerBean.workflow.creationDatestamp}" />
                                    <p:outputLabel value="Quantidade de inputs" style="font-weight: bold"/>
                                    <p:outputLabel value="#{workflowComposerBean.jobs.size()}" />
                                    <p:outputLabel value="Status" style="font-weight: bold"/>
                                    <p:outputLabel value="#{workflowComposerBean.workflowStatus}" 
                                                   style="font-weight: bold; color: #{workflowComposerBean.workflowColor}"/>
                                </p:panelGrid>
                            </p:panel>
                            <br />
                            <center>
                                <h:panelGrid columns="2" style="text-align: center">
                                    <p:panel header="Executar Workflow" style="text-align: center; width: 400px">
                                        <p:outputLabel value="Iniciar execução deste Workflow. Seu Workflow sera enviado ao Servidor do BioNimbuZ e voce podera acompnhar sua execucao" 
                                                       style="margin: 10px" /> <br />
                                        <center>
                                            <p:commandButton action="#{workflowComposerBean.startWorkflow()}" value="Confirmar Workflow" style="margin: 10px; border-color: #2980b9"/>
                                        </center>
                                    </p:panel>
                                    <p:panel header="Download" style="text-align: center; width: 400px">
                                        <p:outputLabel value="Voce pode realizar o download deste Workflow para importa-lo posteriormente ou compartilhar com alguem" 
                                                       style="margin: 10px" /> <br />
                                        <center>
                                            <p:commandButton value="Download" ajax="false" icon="ui-icon-arrowthick-1-s" style="margin: 10px; border-color: #2980b9" >
                                                <p:fileDownload value="#{workflowComposerBean.downloadWorkflow()}" />
                                            </p:commandButton>
                                        </center>
                                    </p:panel>
                                </h:panelGrid>
                            </center>
                        </p:panel>
                    </p:tab>
                </p:wizard>
            </h:form>
        </ui:define>
    </ui:decorate>

    <!-- ***************************************************************************************************************** -->
    <!--                                                        DIALOGS                                                    -->
    <!-- ***************************************************************************************************************** -->
    <!-- File Dialog: Used for the user to pick inputs -->
    <p:dialog widgetVar="file_dlg" showEffect="fade" header="Entrada"
              hideEffect="fade" modal="true" closable="false">
        <h:form id="file_form">

            <p:panel>
                Escolha se a entrada deste passo será um arquivo ou uma URL do arquivo
            </p:panel>
            <br />
            <p:fieldset legend="Argumentos de entrada">
                Argumentos da linha de comando (ex: -X --cached -p 10)
                <h:inputText id="args" style="width: 99%; margin: 3px" value="#{workflowComposerBean.arguments}"/>
            </p:fieldset>
            <br />
            <p:accordionPanel>
                <p:tab title="Arquivos">
                    <p:fieldset id="file_list_dlg" legend="Lista de Arquivos">
                        <p:panel>
                            Caso não tenho realizado o upload dos arquivos necessários para essa execução, faça-o 
                            <p:commandLink value="aqui" action="upload_file"/>
                        </p:panel>
                        <br />
                        <p:dataTable value="#{workflowComposerBean.loggedUser.files}" var="f" style="width: 60em"
                                     paginator="true" rows="5" emptyMessage="Nenhum arquivo encontrado"
                                     selection="#{workflowComposerBean.inputFiles}" rowKey="#{f.name}" >

                            <p:column headerText="Nome" width="25em" style="text-align: center">
                                <p:outputLabel value="#{f.name}"/>
                            </p:column>

                            <p:column headerText="Upload em" width="25em" style="text-align: center">
                                <p:outputLabel value="#{f.uploadTimestamp}"/>
                            </p:column>

                            <p:column headerText="Tamanho" width="25em" style="text-align: center">
                                <p:outputLabel value="#{f.size} Kb"/>
                            </p:column>

                            <p:column headerText="Escolha" style="text-align: center" selectionMode="multiple" />
                        </p:dataTable>
                    </p:fieldset>
                </p:tab>

                <p:tab title="URL">
                    <p:fieldset legend="URL">
                        Digite a URL de onde se encontra seu arquivo (URL de um armazenamento, link do Dropbox, link do Google Drive, ...). <br />
                        Apontar o caminho direto para o arquivo (não apontar pastas, por exemplo):
                        <h:inputText id="url" style="width: 99%; margin: 3px" value="#{workflowComposerBean.inputURL}"/>
                    </p:fieldset>
                </p:tab>

            </p:accordionPanel>
            <br />
            <p:panel>
                Para nao utilizar dados de entrada, clique em 'Pular'. 
                Neste caso, a entrada deste passo sera apenas a saida do passo anterior. <br />
                <p:commandButton value="Confirmar" action="#{workflowComposerBean.setJobFields()}" 
                                 update=":form:growl" style="margin: 5px"
                                 onclick="PF('file_dlg').hide()"/>
                <p:commandButton value="Pular" update=":form:growl" style="margin: 5px"
                                 action="#{workflowComposerBean.setJobFieldsWithOutput()}"
                                 onclick="PF('file_dlg').hide()"/>
            </p:panel>
        </h:form>
    </p:dialog>

</html>